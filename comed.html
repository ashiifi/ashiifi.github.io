<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="ComEd Hourly Pricing Dashboard - Real-time electricity price tracking" />
<title>ComEd Hourly Pricing Dashboard</title>
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="icon" href="/img/favicon.ico" type="image/x-icon" />
<link rel="icon" type="image/png" href="/img/fav.png" />
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>" />
<!-- Google Fonts Roboto -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet" />
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: 'Roboto', sans-serif;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    margin: 0;
    padding: 0;
    color: #1a202c;
    min-height: 100vh;
  }

  /* Sticky Header */
  header {
    position: sticky;
    top: 0;
    background: #1a202c;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    padding: 1rem 1.5rem;
    z-index: 100;
    transition: all 0.3s ease;
  }

  header.compact {
    padding: 0.8rem 1.5rem;
  }

  .header-top {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    text-decoration: none;
    color: white;
  }

  .logo-img {
    height: 40px;
    width: auto;
    filter: brightness(0) invert(1);
  }

  .logo-text {
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  h1 {
    font-weight: 700;
    font-size: 1.8rem;
    margin: 0;
    color: #0052cc;
    letter-spacing: -0.5px;
  }

  .header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .refresh-btn {
    background: #0052cc;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.2s ease;
  }

  .refresh-btn:hover {
    background: #003fa8;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 82, 204, 0.3);
  }

  .refresh-btn.loading {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .time-updated {
    font-size: 0.85rem;
    color: #cbd5e0;
    margin: 0;
  }

  /* Main Container */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  /* Hero Section (lighter variant) */
  .hero {
    background: linear-gradient(135deg, #eaf4ff 0%, #d6eaff 100%);
    border-radius: 16px;
    padding: 3rem 2rem;
    color: #0b2540;
    margin-bottom: 2rem;
    box-shadow: 0 8px 24px rgba(11, 37, 64, 0.06);
    position: relative;
    overflow: hidden;
  }

  .hero::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 500px;
    height: 500px;
    background: rgba(11, 37, 64, 0.03);
    border-radius: 50%;
    animation: drift 8s ease-in-out infinite;
  }

  @keyframes drift {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(30px, 30px); }
  }

  .hero-content {
    position: relative;
    z-index: 2;
    text-align: center;
  }

  .current-price-display {
    margin: 1rem 0 1.5rem;
  }

  .current-price {
    font-size: 4rem;
    font-weight: 700;
    margin: 0;
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.02em;
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .price-trend {
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0.5rem 0 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .trend-up {
    color: #dc2626;
  }

  .trend-down {
    color: #059669;
  }

  .trend-neutral {
    color: #d97706;
  }

  .price-indicator {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(10px);
    margin-top: 1rem;
  }

  .price-indicator.cheap {
    background: rgba(16, 185, 129, 0.3);
  }

  .price-indicator.normal {
    background: rgba(245, 158, 11, 0.3);
  }

  .price-indicator.expensive {
    background: rgba(239, 68, 68, 0.3);
  }

  .peak-badge {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-left: 0.8rem;
    background: rgba(255, 255, 255, 0.2);
  }

  /* Savings Tip */
  .savings-tip {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .tip-icon {
    font-size: 1.5rem;
    min-width: 1.5rem;
  }

  /* Hourly Table */
  .hourly-table-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .table-toggle {
    background: none;
    border: none;
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0;
    cursor: pointer;
    font-size: 1.2rem;
    font-weight: 600;
    color: #1a202c;
  }

  .table-toggle:hover {
    color: #0052cc;
  }

  .toggle-icon {
    font-size: 1rem;
    transition: transform 0.3s ease;
  }

  .toggle-icon.open {
    transform: rotate(180deg);
  }

  .hourly-table {
    margin-top: 1rem;
    width: 100%;
    border-collapse: collapse;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .hourly-table.open {
    max-height: 1000px;
  }

  .hourly-table th,
  .hourly-table td {
    padding: 0.8rem;
    text-align: right;
    border-bottom: 1px solid #e2e8f0;
    font-size: 0.9rem;
  }

  .hourly-table th {
    background: #f7fafc;
    font-weight: 600;
    color: #718096;
    text-align: right;
  }

  .hourly-table th:first-child,
  .hourly-table td:first-child {
    text-align: left;
  }

  .hourly-table tr:hover {
    background: #f7fafc;
  }

  .hour-price {
    font-weight: 600;
    font-variant-numeric: tabular-nums;
  }

  .hour-price.cheap {
    color: #10b981;
  }

  .hour-price.normal {
    color: #f59e0b;
  }

  .hour-price.expensive {
    color: #ef4444;
  }

  /* Metrics Cards */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .metric-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
  }

  .metric-card:hover {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    transform: translateY(-4px);
  }

  .metric-label {
    font-size: 0.85rem;
    color: #718096;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.6rem;
  }

  .metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: #0052cc;
    margin-bottom: 0.4rem;
    font-variant-numeric: tabular-nums;
  }

  .metric-detail {
    font-size: 0.9rem;
    color: #718096;
  }

  .metric-detail.positive {
    color: #51cf66;
  }

  .metric-detail.negative {
    color: #ff6b6b;
  }

  /* Colors for price status */
  .cheap {
    background-color: #10b981; /* Green */
  }
  .normal {
    background-color: #f59e0b; /* Amber */
  }
  .expensive {
    background-color: #ef4444; /* Red */
  }

  .chart-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .chart-title {
    font-weight: 600;
    font-size: 1.2rem;
    color: #1a202c;
    margin: 0 0 1rem 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chart-subtitle {
    font-size: 0.85rem;
    color: #718096;
    margin: -0.8rem 0 1rem 0;
  }

  canvas {
    max-height: 400px;
    animation: fadeIn 0.4s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Peak Hours Indicator */
  .peak-hours-info {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 1rem;
    border-radius: 6px;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
    color: #78350f;
  }

  /* Footer */
  footer {
    text-align: center;
    padding: 2rem 1rem;
    color: #718096;
    font-size: 0.85rem;
  }

  footer a {
    color: #0052cc;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  footer a:hover {
    color: #0039a6;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      padding: 1rem 1rem;
    }

    h1 {
      font-size: 1.4rem;
    }

    .current-price {
      font-size: 2.5rem;
    }

    .hero {
      padding: 2rem 1.5rem;
    }

    .header-top {
      flex-direction: column;
      align-items: flex-start;
    }

    .header-actions {
      width: 100%;
      justify-content: space-between;
    }

    .metrics-grid {
      grid-template-columns: 1fr;
    }

    canvas {
      max-height: 300px;
    }
  }
  /* Estimator Panel */
  .estimator-panel {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }

  .estimator-row {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 0.75rem;
  }

  .preset-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 0.6rem;
    margin-top: 0.75rem;
  }

  .preset-btn {
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    padding: 0.6rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    text-align: left;
  }

  .preset-btn.active {
    background: #0052cc;
    color: white;
  }

  .est-input {
    padding: 0.5rem 0.6rem;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    width: 120px;
    font-weight: 600;
  }

  .estimate-result {
    margin-top: 0.75rem;
    font-size: 1.05rem;
    font-weight: 700;
  }

  .est-controls {
    display:flex;
    gap:0.6rem;
    align-items:center;
    margin-top:0.6rem;
  }

  .saved-list {
    margin-top:0.75rem;
    display:flex;
    gap:0.5rem;
    flex-wrap:wrap;
  }

  .saved-item {
    background:#eef2ff;
    border:1px solid #e0e7ff;
    padding:0.5rem 0.6rem;
    border-radius:8px;
    font-weight:600;
    display:flex;
    gap:0.5rem;
    align-items:center;
  }

  .small-btn {
    padding:0.35rem 0.5rem;
    border-radius:6px;
    border:1px solid #cbd5e1;
    background:#fff;
    cursor:pointer;
    font-weight:600;
  }
</style>
</head>
<body>
  <header>
    <div class="header-top">
      <a href="https://www.comed.com" target="_blank" rel="noopener noreferrer" class="logo">
        <img src="https://hourlypricing.comed.com/wp-content/themes/rrtp/dist/images/branding/hp-header-logo.svg" alt="ComEd" class="logo-img" />
      </a>
      <div class="header-actions">
        <button class="refresh-btn" id="refreshBtn">‚Üª Refresh</button>
        <p class="time-updated" id="timeUpdated">Initializing...</p>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Hero Section -->
    <div class="hero">
      <div class="hero-content">
        <div class="current-price-display">
          <p class="current-price" id="currentPrice">$0.0000</p>
          <p class="price-trend" id="priceTrend">
            <span id="trendArrow">‚Äî</span>
            <span id="trendText">No data</span>
          </p>
        </div>
        <div id="priceIndicator" class="price-indicator"></div>
        <span class="peak-badge" id="peakBadge"></span>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">24h Low</div>
        <div class="metric-value" id="metricLow">$0.0000</div>
        <div class="metric-detail" id="metricLowTime">‚Äî</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">24h High</div>
        <div class="metric-value" id="metricHigh">$0.0000</div>
        <div class="metric-detail" id="metricHighTime">‚Äî</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">vs. 24h Average</div>
        <div class="metric-value" id="metricAvgCompare">‚Äî</div>
        <div class="metric-detail" id="metricAvgDetail">‚Äî</div>
      </div>
    </div>

    <!-- Daily Summary -->
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-label">Yesterday's Avg</div>
        <div class="metric-value" id="yesterdayAvg">$0.0000</div>
        <div class="metric-detail" id="yesterdayTrend">‚Äî</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Today's Avg So Far</div>
        <div class="metric-value" id="todayAvg">$0.0000</div>
        <div class="metric-detail" id="todayTrend">‚Äî</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Current Price Percentile</div>
        <div class="metric-value" id="percentile">‚Äî</div>
        <div class="metric-detail" id="percentileText">‚Äî</div>
      </div>
    </div>

    <!-- Savings Tip -->
    <div class="savings-tip" id="savingsTip">
      <span class="tip-icon">üí°</span>
      <span id="tipText">Loading price data...</span>
    </div>

    <!-- Peak Hours Info -->
    <div class="peak-hours-info" id="peakHoursInfo">
      Peak hours: 2 PM - 8 PM (weekdays) ‚Ä¢ Off-peak: 9 PM - 6 AM
    </div>

    <!-- Estimator Panel -->
    <div class="estimator-panel" id="estimatorPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:700;font-size:1.1rem;">Cost Estimator</div>
        <div style="font-size:0.9rem;color:#718096">Estimate what running an appliance costs now</div>
      </div>

      <div style="margin-top:0.75rem;color:#4a5568;font-size:0.95rem;">Select a preset or enter custom values. Estimates use the current price per kWh.</div>

      <div class="preset-grid" id="presetGrid">
        <!-- Preset buttons injected by JS -->
      </div>

      <div class="estimator-row">
        <label style="font-weight:600;">Power (kW)</label>
        <input type="number" step="0.1" min="0" id="estPower" class="est-input" />

        <label style="font-weight:600;">Duration (min)</label>
        <input type="number" step="1" min="0" id="estDuration" class="est-input" />

        <label style="font-weight:600;">Or energy (kWh)</label>
        <input type="number" step="0.1" min="0" id="estEnergy" class="est-input" />

        <button id="estimateBtn" class="refresh-btn" style="padding:0.45rem 0.8rem;">Estimate</button>
        <label style="font-weight:600;margin-left:6px;">Price ($/kWh)</label>
        <input type="number" step="0.0001" min="0" id="estPrice" class="est-input" placeholder="auto" style="width:100px;" />
        <label style="display:flex;align-items:center;gap:0.35rem;font-weight:600"><input type="checkbox" id="estUseCustom" />Use custom</label>
        <button id="startRunBtn" class="small-btn" type="button">Start Now</button>
        <button id="savePresetBtn" class="small-btn" type="button">Save Preset</button>
      </div>

      <div class="estimate-result" id="estimateResult">Estimated cost: ‚Äî</div>
      <div style="font-size:0.9rem;color:#718096;margin-top:0.25rem;" id="estimateDetail">Using current price: ‚Äî / kWh</div>
      <div style="margin-top:0.35rem;font-size:0.9rem;color:#4a5568;" id="co2Estimate">Estimated CO2: ‚Äî kg</div>

      <div class="est-controls">
        <div id="liveRunDisplay" style="font-weight:700;color:#1a202c">Not running</div>
      </div>

      <div style="margin-top:0.5rem;font-size:0.95rem;color:#4a5568">Saved appliances:</div>
      <div class="saved-list" id="savedList"></div>
    </div>

    <!-- Hourly Summary Table -->
    <div class="hourly-table-section">
      <button class="table-toggle" id="tableToggle">
        <span>Today's Hourly Breakdown</span>
        <span class="toggle-icon">‚ñº</span>
      </button>
      <table class="hourly-table" id="hourlyTable">
        <thead>
          <tr>
            <th>Hour</th>
            <th>Price</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="hourlyTableBody">
          <tr>
            <td colspan="3" style="text-align: center; color: #718096;">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Charts -->
    <div class="chart-section">
      <h2 class="chart-title">5-Minute Prices</h2>
      <p class="chart-subtitle">Last 5 hours of pricing data</p>
      <canvas id="fiveMinChart"></canvas>
    </div>

    <div class="chart-section">
      <h2 class="chart-title">Hourly Average</h2>
      <p class="chart-subtitle" id="chartSubtitle">Last 24 hours</p>
      <canvas id="hourlyAvgChart"></canvas>
    </div>
  </div>

  <footer>
    Created by <a href="https://www.linkedin.com/in/abubakrsharif/" target="_blank" rel="noopener noreferrer">Abubakr Sharif</a>
  </footer>

<script>
// Constants
const PRICE_THRESHOLDS = {
  cheap: 0.04,
  normal: 0.10
};

const PEAK_HOURS = {
  start: 14, // 2 PM
  end: 20    // 8 PM
};

const proxyUrl = 'https://corsproxy.io/?';
const feedUrl = 'https://hourlypricing.comed.com/api?type=5minutefeed&format=json';
// CO2 estimate (kg CO2 per kWh) - approximate average
const CO2_PER_KWH_KG = 0.417;

let fiveMinChart, hourlyAvgChart;
let currentData = [];
let selectedDays = 1;
let lastUpdateTime = null;
let currentPricePerKWh = 0;

// Estimator presets
const ESTIMATOR_PRESETS = [
  { label: 'EV (Level 2)', powerKW: 7.2, durationMin: 360 },
  { label: 'EV Fast (11kW)', powerKW: 11, durationMin: 360 },
  { label: 'Dishwasher (run)', powerKW: 1.5, durationMin: 90 },
  { label: 'Washer (run)', powerKW: 0.5, durationMin: 60 },
  { label: 'Dryer (run)', powerKW: 3.3, durationMin: 60 },
  { label: 'Water Heater (2h)', powerKW: 4.5, durationMin: 120 },
  { label: 'Custom kWh', energyKWh: 1 }
];

let activePreset = null;

function renderPresets() {
  const grid = document.getElementById('presetGrid');
  grid.innerHTML = '';
  ESTIMATOR_PRESETS.forEach((p, idx) => {
    const btn = document.createElement('button');
    btn.className = 'preset-btn';
    btn.type = 'button';
    btn.innerHTML = `<div style="font-size:0.95rem">${p.label}</div><div style="font-size:0.85rem;color:#718096;margin-top:0.25rem">${p.powerKW ? p.powerKW + ' kW' : (p.energyKWh ? p.energyKWh + ' kWh' : '')}${p.durationMin ? ' ¬∑ ' + Math.round(p.durationMin/60*10)/10 + 'h' : ''}</div>`;
    btn.addEventListener('click', () => setPreset(idx, btn));
    grid.appendChild(btn);
  });
}

function setPreset(idx, btn) {
  activePreset = ESTIMATOR_PRESETS[idx];
  // toggle active class
  document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  // populate inputs
  if (activePreset.energyKWh) {
    document.getElementById('estEnergy').value = activePreset.energyKWh;
    document.getElementById('estPower').value = '';
    document.getElementById('estDuration').value = '';
  } else {
    document.getElementById('estPower').value = activePreset.powerKW || '';
    document.getElementById('estDuration').value = activePreset.durationMin || '';
    document.getElementById('estEnergy').value = '';
  }
  updateEstimatorDisplay();
}

function calculateEstimate({ powerKW = 0, durationMin = 0, energyKWh = 0, pricePerKWh = currentPricePerKWh }) {
  // If energy is provided, use it. Otherwise compute from power and duration.
  let kWh = 0;
  if (energyKWh && energyKWh > 0) kWh = energyKWh;
  else kWh = powerKW * (durationMin / 60);
  const cost = kWh * pricePerKWh;
  return { kWh, cost };
}

function updateEstimatorDisplay() {
  const customPrice = parseFloat(document.getElementById('estPrice').value || 0);
  const useCustom = document.getElementById('estUseCustom') ? document.getElementById('estUseCustom').checked : false;
  const pricePerKWh = (useCustom && customPrice > 0) ? customPrice : currentPricePerKWh;
  const priceText = pricePerKWh > 0 ? `$${pricePerKWh.toFixed(4)} / kWh` : '‚Äî / kWh';
  const sourceText = (useCustom && customPrice > 0) ? 'Using custom price:' : 'Using current price:';
  document.getElementById('estimateDetail').textContent = `${sourceText} ${priceText}`;

  // if inputs exist, auto-calc
  const p = parseFloat(document.getElementById('estPower').value || 0);
  const d = parseFloat(document.getElementById('estDuration').value || 0);
  const e = parseFloat(document.getElementById('estEnergy').value || 0);
  if ((p > 0 && d > 0) || (e > 0)) {
    const res = calculateEstimate({ powerKW: p, durationMin: d, energyKWh: e, pricePerKWh });
    document.getElementById('estimateResult').textContent = `Estimated cost: $${res.cost.toFixed(2)} (${res.kWh.toFixed(2)} kWh)`;
    const co2kg = res.kWh * CO2_PER_KWH_KG;
    document.getElementById('co2Estimate').textContent = `Estimated CO2: ${co2kg.toFixed(2)} kg`;
  } else {
    document.getElementById('estimateResult').textContent = 'Estimated cost: ‚Äî';
    document.getElementById('co2Estimate').textContent = 'Estimated CO2: ‚Äî kg';
  }
}

document.addEventListener('DOMContentLoaded', () => {
  renderPresets();
  document.getElementById('estimateBtn').addEventListener('click', () => updateEstimatorDisplay());
  document.getElementById('estPower').addEventListener('input', () => { document.getElementById('estEnergy').value = ''; updateEstimatorDisplay(); });
  document.getElementById('estDuration').addEventListener('input', () => { document.getElementById('estEnergy').value = ''; updateEstimatorDisplay(); });
  document.getElementById('estEnergy').addEventListener('input', () => { document.getElementById('estPower').value = ''; document.getElementById('estDuration').value = ''; updateEstimatorDisplay(); });
  // estimator controls
  const startBtn = document.getElementById('startRunBtn');
  if (startBtn) startBtn.addEventListener('click', () => toggleRun());
  const saveBtn = document.getElementById('savePresetBtn');
  if (saveBtn) saveBtn.addEventListener('click', () => saveAppliance());
  const priceInput = document.getElementById('estPrice');
  if (priceInput) priceInput.addEventListener('input', () => updateEstimatorDisplay());
  const useCustom = document.getElementById('estUseCustom');
  if (useCustom) useCustom.addEventListener('change', () => updateEstimatorDisplay());
  renderSavedList();
});

// Saved appliances (localStorage)
const STORAGE_KEY = 'savedAppliances_v1';
function loadSavedAppliances() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    return JSON.parse(raw);
  } catch (e) { return []; }
}

function saveSavedAppliances(arr) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr || []));
}

function saveAppliance() {
  const p = parseFloat(document.getElementById('estPower').value || 0);
  const d = parseFloat(document.getElementById('estDuration').value || 0);
  const e = parseFloat(document.getElementById('estEnergy').value || 0);
  if (!((p > 0 && d > 0) || (e > 0))) {
    alert('Enter a valid power+duration or energy to save as a preset.');
    return;
  }
  const name = prompt('Name for this appliance/preset:', p && d ? `${p}kW ¬∑ ${d}min` : `${e} kWh`);
  if (!name) return;
  const arr = loadSavedAppliances();
  arr.push({ name, powerKW: p||null, durationMin: d||null, energyKWh: e||null });
  saveSavedAppliances(arr);
  renderSavedList();
  alert('Saved preset.');
}

function deleteSavedAppliance(idx) {
  const arr = loadSavedAppliances();
  arr.splice(idx,1);
  saveSavedAppliances(arr);
  renderSavedList();
}

function loadApplianceToInputs(item) {
  if (!item) return;
  if (item.energyKWh) {
    document.getElementById('estEnergy').value = item.energyKWh;
    document.getElementById('estPower').value = '';
    document.getElementById('estDuration').value = '';
  } else {
    document.getElementById('estPower').value = item.powerKW || '';
    document.getElementById('estDuration').value = item.durationMin || '';
    document.getElementById('estEnergy').value = '';
  }
  updateEstimatorDisplay();
}

function renderSavedList() {
  const container = document.getElementById('savedList');
  if (!container) return;
  container.innerHTML = '';
  const arr = loadSavedAppliances();
  arr.forEach((item, idx) => {
    const el = document.createElement('div');
    el.className = 'saved-item';
    el.innerHTML = `<div style="min-width:120px">${item.name}</div>`;
    const loadBtn = document.createElement('button');
    loadBtn.className = 'small-btn';
    loadBtn.textContent = 'Load';
    loadBtn.addEventListener('click', () => loadApplianceToInputs(item));
    const delBtn = document.createElement('button');
    delBtn.className = 'small-btn';
    delBtn.textContent = 'Delete';
    delBtn.addEventListener('click', () => { if (confirm('Delete preset?')) deleteSavedAppliance(idx); });
    el.appendChild(loadBtn);
    el.appendChild(delBtn);
    container.appendChild(el);
  });
}

// Live run timer
let runInterval = null;
let runStartTime = null;
let runTotalSec = 0;

function toggleRun() {
  if (runInterval) stopRun(); else startRun();
}

function startRun() {
  const p = parseFloat(document.getElementById('estPower').value || 0);
  const d = parseFloat(document.getElementById('estDuration').value || 0);
  const e = parseFloat(document.getElementById('estEnergy').value || 0);
  if (!((p > 0 && d > 0) || (e > 0 && d > 0))) {
    alert('To run live estimation please provide a duration (minutes) and either power or energy.');
    return;
  }
  runStartTime = Date.now();
  runTotalSec = Math.max(1, Math.round(d * 60));
  const btn = document.getElementById('startRunBtn');
  if (btn) btn.textContent = 'Stop';
  runInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - runStartTime) / 1000);
    updateLiveRunDisplay(elapsed, p, d, e);
    if (elapsed >= runTotalSec) stopRun();
  }, 1000);
  updateLiveRunDisplay(0, p, d, e);
}

function stopRun() {
  clearInterval(runInterval);
  runInterval = null;
  const btn = document.getElementById('startRunBtn');
  if (btn) btn.textContent = 'Start Now';
  const display = document.getElementById('liveRunDisplay');
  if (display) display.textContent = 'Not running';
}

function updateLiveRunDisplay(elapsedSec = 0, powerKW = 0, durationMin = 0, energyKWh = 0) {
  // compute kWh so far
  let totalKWh = 0;
  if (energyKWh && durationMin > 0) {
    totalKWh = energyKWh * Math.min(elapsedSec / (durationMin*60), 1);
  } else if (powerKW && durationMin > 0) {
    const total = powerKW * (durationMin/60);
    totalKWh = total * Math.min(elapsedSec / (durationMin*60), 1);
  }
  // respect custom price override if set
  const customPrice = parseFloat(document.getElementById('estPrice') ? document.getElementById('estPrice').value || 0 : 0);
  const useCustom = document.getElementById('estUseCustom') ? document.getElementById('estUseCustom').checked : false;
  const pricePerKWh = (useCustom && customPrice > 0) ? customPrice : currentPricePerKWh;
  const costSoFar = totalKWh * pricePerKWh;
  const co2SoFar = totalKWh * CO2_PER_KWH_KG;
  const mm = String(Math.floor(elapsedSec/60)).padStart(2,'0');
  const ss = String(elapsedSec % 60).padStart(2,'0');
  const display = document.getElementById('liveRunDisplay');
  if (display) display.textContent = `Running ${mm}:${ss} ‚Äî $${costSoFar.toFixed(2)} (${totalKWh.toFixed(2)} kWh) ‚Ä¢ ${co2SoFar.toFixed(2)} kg CO2`;
}

// Utility functions
function zpad(num) {
  return num.toString().padStart(2, '0');
}

function getColorForPrice(price) {
  if (price < PRICE_THRESHOLDS.cheap) return '#10b981';  // Green
  if (price < PRICE_THRESHOLDS.normal) return '#f59e0b'; // Amber
  return '#ef4444';                                        // Red
}

function getPriceStatus(price) {
  if (price < PRICE_THRESHOLDS.cheap) {
    return { text: "Cheap", className: "cheap" };
  }
  if (price < PRICE_THRESHOLDS.normal) {
    return { text: "Normal", className: "normal" };
  }
  return { text: "Expensive", className: "expensive" };
}

function isPeakHour(date) {
  const hour = date.getHours();
  const dayOfWeek = date.getDay();
  // Peak hours on weekdays (Mon-Fri)
  return dayOfWeek > 0 && dayOfWeek < 6 && hour >= PEAK_HOURS.start && hour < PEAK_HOURS.end;
}

function getTimeAgo(ms) {
  const now = Date.now();
  const diff = now - ms;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (minutes < 1) return "just now";
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  return `${days}d ago`;
}

function ordinalSuffix(n) {
  const num = Math.round(n);
  const j = num % 10, k = num % 100;
  if (k >= 11 && k <= 13) return 'th';
  if (j === 1) return 'st';
  if (j === 2) return 'nd';
  if (j === 3) return 'rd';
  return 'th';
}

async function fetchData() {
  try {
    const resp = await fetch(proxyUrl + encodeURIComponent(feedUrl));
    if (!resp.ok) throw new Error('API failed');
    const data = await resp.json();
    if (!data || data.length === 0) throw new Error('Empty response from API');
    return data;
  } catch (error) {
    console.error('Fetch error:', error);
    // Try alternative CORS proxy
    try {
      const altResp = await fetch('https://api.allorigins.win/raw?url=' + encodeURIComponent(feedUrl));
      if (!altResp.ok) throw new Error('Alt proxy also failed');
      const data = await altResp.json();
      if (data && data.length > 0) return data;
    } catch (altError) {
      console.error('Alternative proxy also failed:', altError);
    }
    showErrorMessage('Unable to load pricing data. The service may be temporarily unavailable.');
    return [];
  }
}

function showErrorMessage(msg) {
  const container = document.getElementById('metrics-container');
  if (container) {
    container.innerHTML = `<div style="grid-column: 1/-1; padding: 2rem; text-align: center; background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; color: #856404;"><strong>‚ö†Ô∏è Data Load Error:</strong> ${msg}</div>` + container.innerHTML;
  }
}

function calculateMetrics(data, days) {
  const now = Date.now();
  const cutoff = now - days * 24 * 60 * 60 * 1000;
  const relevant = data.filter(d => +d.millisUTC >= cutoff && +d.millisUTC <= now);
  
  if (relevant.length === 0) {
    return { min: 0, max: 0, avg: 0, minTime: null, maxTime: null };
  }
  
  const prices = relevant.map(d => +d.price / 100);
  const min = Math.min(...prices);
  const max = Math.max(...prices);
  const avg = prices.reduce((a, b) => a + b) / prices.length;
  
  const minEntry = relevant.find(d => +d.price / 100 === min);
  const maxEntry = relevant.find(d => +d.price / 100 === max);
  
  return {
    min,
    max,
    avg,
    minTime: minEntry ? new Date(+minEntry.millisUTC) : null,
    maxTime: maxEntry ? new Date(+maxEntry.millisUTC) : null
  };
}

function buildHourlyTable(data) {
  const now = Date.now();
  const todayStart = new Date(now);
  todayStart.setHours(0, 0, 0, 0);
  
  const hourly = {};
  data.forEach(entry => {
    const date = new Date(+entry.millisUTC);
    if (date.getTime() >= todayStart.getTime()) {
      const hour = date.getHours();
      if (!hourly[hour]) hourly[hour] = [];
      hourly[hour].push(+entry.price / 100);
    }
  });

  const tbody = document.getElementById('hourlyTableBody');
  tbody.innerHTML = '';

  for (let hour = 0; hour < 24; hour++) {
    if (hourly[hour] && hourly[hour].length > 0) {
      const prices = hourly[hour];
      const avg = prices.reduce((a, b) => a + b) / prices.length;
      const status = getPriceStatus(avg);
      
      const row = document.createElement('tr');
      const hourLabel = new Date(2024, 0, 1, hour).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      row.innerHTML = `
        <td>${hourLabel}</td>
        <td class="hour-price ${status.className}">$${avg.toFixed(4)}</td>
        <td>${status.text}</td>
      `;
      tbody.appendChild(row);
    }
  }
}

function buildFiveMinChart(data) {
  const now = Date.now();
  const cutoff = now - 5 * 60 * 60 * 1000;
  const recent = data.filter(d => +d.millisUTC >= cutoff && +d.millisUTC <= now);
  recent.sort((a, b) => +a.millisUTC - +b.millisUTC);

  const labels = recent.map((d) => {
    const dt = new Date(+d.millisUTC);
    return dt.getMinutes() % 15 === 0
      ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : '';
  });
  
  const values = recent.map(d => +d.price / 100);
  const pointColors = values.map(v => getColorForPrice(v));

  if (fiveMinChart) fiveMinChart.destroy();

  const ctx = document.getElementById('fiveMinChart').getContext('2d');
  fiveMinChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: '5-Min Price ($/kWh)',
        data: values,
        borderColor: '#0052cc',
        backgroundColor: 'rgba(0, 82, 204, 0.08)',
        fill: true,
        tension: 0.4,
        pointRadius: 5,
        pointHoverRadius: 7,
        pointBackgroundColor: pointColors,
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        borderWidth: 2.5,
        cubicInterpolationMode: 'monotone',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          backgroundColor: '#1a202c',
          titleColor: '#fff',
          bodyColor: '#fff',
          padding: 12,
          borderRadius: 6,
          callbacks: {
            label: ctx => `$${ctx.parsed.y.toFixed(4)} / kWh`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#718096',
            font: { weight: '600', size: 12 }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#718096',
            callback: val => `$${val.toFixed(3)}`,
            font: { weight: '600' }
          },
          grid: {
            color: 'rgba(0, 82, 204, 0.1)',
            drawBorder: false
          }
        }
      }
    }
  });
}

function buildHourlyAvgChart(data, days = 1) {
  const now = Date.now();
  const cutoff = now - days * 24 * 60 * 60 * 1000;
  const relevant = data.filter(d => +d.millisUTC >= cutoff && +d.millisUTC <= now);

  const hourly = {};
  relevant.forEach(entry => {
    const date = new Date(+entry.millisUTC);
    const key = `${date.getFullYear()}-${zpad(date.getMonth()+1)}-${zpad(date.getDate())}T${zpad(date.getHours())}`;
    if (!hourly[key]) hourly[key] = [];
    hourly[key].push(+entry.price);
  });

  const entries = Object.entries(hourly).sort((a,b) => new Date(a[0]) - new Date(b[0]));

  const labels = entries.map(e => {
    const [datePart, hourPart] = e[0].split('T');
    const [year, month, day] = datePart.split('-').map(Number);
    const hour = Number(hourPart);
    const dt = new Date(year, month - 1, day, hour);
    return dt.toLocaleString([], { month: 'short', day: 'numeric', hour: '2-digit' });
  });

  const avgPrices = entries.map(e => ((e[1].reduce((s,p)=>s+p,0) / e[1].length) / 100));
  const barColors = avgPrices.map(p => getColorForPrice(p));
  const values = avgPrices.map(p => +p.toFixed(4));

  if (hourlyAvgChart) hourlyAvgChart.destroy();

  const ctx = document.getElementById('hourlyAvgChart').getContext('2d');
  hourlyAvgChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Hourly Avg ($/kWh)',
        data: values,
        backgroundColor: barColors,
        borderRadius: 6,
        borderSkipped: false,
        maxBarThickness: 40
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { 
          enabled: true,
          backgroundColor: '#1a202c',
          titleColor: '#fff',
          bodyColor: '#fff',
          padding: 12,
          borderRadius: 6,
          callbacks: {
            label: ctx => `$${ctx.parsed.y.toFixed(4)} / kWh`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#718096',
            font: { weight: '600', size: 12 }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#718096',
            callback: val => `$${val.toFixed(3)}`,
            font: { weight: '600' }
          },
          grid: {
            color: 'rgba(0, 82, 204, 0.1)',
            drawBorder: false
          }
        }
      }
    }
  });
}

async function updateDashboard() {
  const btn = document.getElementById('refreshBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  const data = await fetchData();
  if (data.length === 0) {
    btn.classList.remove('loading');
    btn.disabled = false;
    return;
  }

  currentData = data;
  lastUpdateTime = Date.now();

  // Update current price
  const now = Date.now();
  const validEntries = data.filter(d => +d.millisUTC <= now);
  if (validEntries.length === 0) {
    btn.classList.remove('loading');
    btn.disabled = false;
    return;
  }

  const latest = validEntries.reduce((a, b) => +a.millisUTC > +b.millisUTC ? a : b);
  const priceDollars = +latest.price / 100;
  const priceFixed = priceDollars.toFixed(4);

  document.getElementById('currentPrice').textContent = `$${priceFixed}`;
  // update global current price for estimator
  currentPricePerKWh = priceDollars;
  try { updateEstimatorDisplay(); } catch(e) { /* noop if UI not ready */ }
  
  // Price trend (vs previous hour)
  const oneHourAgo = now - 60 * 60 * 1000;
  const prevHourData = data.filter(d => +d.millisUTC >= oneHourAgo - 5*60*1000 && +d.millisUTC <= oneHourAgo + 5*60*1000);
  let trendArrow = '‚Äî';
  let trendClass = 'trend-neutral';
  let trendText = 'No change';
  
  if (prevHourData.length > 0) {
    const prevPrice = (prevHourData.reduce((s, d) => s + +d.price, 0) / prevHourData.length) / 100;
    const change = ((priceDollars - prevPrice) / prevPrice) * 100;
    if (change > 0.5) {
      trendArrow = '‚Üë';
      trendClass = 'trend-up';
      trendText = `+${change.toFixed(1)}% vs 1h ago`;
    } else if (change < -0.5) {
      trendArrow = '‚Üì';
      trendClass = 'trend-down';
      trendText = `${change.toFixed(1)}% vs 1h ago`;
    }
  }
  
  document.getElementById('trendArrow').textContent = trendArrow;
  document.getElementById('trendArrow').className = trendClass;
  document.getElementById('trendText').textContent = trendText;
  document.getElementById('trendText').className = trendClass;

  // Price indicator
  const indicator = getPriceStatus(priceDollars);
  const priceIndicatorEl = document.getElementById('priceIndicator');
  priceIndicatorEl.textContent = indicator.text;
  priceIndicatorEl.className = `price-indicator ${indicator.className}`;

  // Peak hour badge
  const latestDate = new Date(+latest.millisUTC);
  const peakBadge = document.getElementById('peakBadge');
  if (isPeakHour(latestDate)) {
    peakBadge.textContent = '‚ö† PEAK HOURS';
    peakBadge.style.display = 'inline-block';
  } else {
    peakBadge.style.display = 'none';
  }

  // Update metrics
  const metrics = calculateMetrics(data, 1);
  document.getElementById('metricLow').textContent = `$${metrics.min.toFixed(4)}`;
  document.getElementById('metricLowTime').textContent = metrics.minTime ? `at ${metrics.minTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : '‚Äî';
  
  document.getElementById('metricHigh').textContent = `$${metrics.max.toFixed(4)}`;
  document.getElementById('metricHighTime').textContent = metrics.maxTime ? `at ${metrics.maxTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : '‚Äî';
  
  const avgDiff = ((priceDollars - metrics.avg) / metrics.avg) * 100;
  const avgCompareEl = document.getElementById('metricAvgCompare');
  const avgDetailEl = document.getElementById('metricAvgDetail');
  avgCompareEl.textContent = `${avgDiff > 0 ? '+' : ''}${avgDiff.toFixed(1)}%`;
  avgCompareEl.className = `metric-value ${avgDiff > 0 ? 'negative' : 'positive'}`;
  avgDetailEl.textContent = `Current vs $${metrics.avg.toFixed(4)} avg`;
  avgDetailEl.className = `metric-detail ${avgDiff > 0 ? 'negative' : 'positive'}`;

  // Calculate yesterday's data
  const oneDayAgo = now - 24 * 60 * 60 * 1000;
  const yesterdayData = data.filter(d => +d.millisUTC >= oneDayAgo - 24*60*60*1000 && +d.millisUTC < oneDayAgo);
  let yesterdayAvg = 0;
  if (yesterdayData.length > 0) {
    yesterdayAvg = yesterdayData.reduce((s, d) => s + +d.price, 0) / yesterdayData.length / 100;
  }

  // Today's running average
  const todayStart = new Date(now);
  todayStart.setHours(0, 0, 0, 0);
  const todayData = data.filter(d => +d.millisUTC >= todayStart.getTime());
  let todayAvg = 0;
  if (todayData.length > 0) {
    todayAvg = todayData.reduce((s, d) => s + +d.price, 0) / todayData.length / 100;
  }

  document.getElementById('yesterdayAvg').textContent = `$${yesterdayAvg.toFixed(4)}`;
  const yestDiff = ((todayAvg - yesterdayAvg) / yesterdayAvg) * 100;
  document.getElementById('yesterdayTrend').textContent = yesterdayAvg > 0 ? (yestDiff > 0 ? `‚Üë +${yestDiff.toFixed(1)}% today` : `‚Üì ${yestDiff.toFixed(1)}% today`) : '‚Äî';
  document.getElementById('yesterdayTrend').className = yestDiff > 0 ? 'metric-detail negative' : 'metric-detail positive';

  document.getElementById('todayAvg').textContent = `$${todayAvg.toFixed(4)}`;
  document.getElementById('todayTrend').textContent = `${todayData.length} data points`;

  // Calculate price percentile (historical)
  const allPrices = data.map(d => +d.price / 100);
  const sortedPrices = [...allPrices].sort((a, b) => a - b);
  const percentileRank = (sortedPrices.filter(p => p <= priceDollars).length / sortedPrices.length) * 100;
  document.getElementById('percentile').textContent = `${percentileRank.toFixed(0)}${ordinalSuffix(Math.round(percentileRank))}`;
  const percentileText = percentileRank < 33 ? 'Better than typical' : percentileRank < 67 ? 'Around typical' : 'Higher than typical';
  document.getElementById('percentileText').textContent = percentileText;

  // Savings tip
  const tipEl = document.getElementById('tipText');
  let tipIcon = 'üí°';
  let tipText = '';
  
  if (priceDollars < metrics.min * 1.05 && metrics.minTime && Math.abs(now - +metrics.minTime.getTime()) < 30*60*1000) {
    tipIcon = 'üéâ';
    tipText = 'Great timing! Current price is near today\'s low!';
  } else if (priceDollars > metrics.max * 0.95 && metrics.maxTime && Math.abs(now - +metrics.maxTime.getTime()) < 30*60*1000) {
    tipIcon = '‚ö†Ô∏è';
    tipText = 'Expensive time now - consider shifting heavy loads to off-peak hours.';
  } else if (percentileRank < 25) {
    tipIcon = '‚ú®';
    tipText = 'Prices are cheap! Perfect time to run high-energy tasks.';
  } else if (percentileRank > 75) {
    tipIcon = '‚ö†Ô∏è';
    tipText = 'Prices are high. Consider delaying heavy electrical usage.';
  } else if (isPeakHour(latestDate)) {
    tipIcon = 'üìà';
    tipText = 'Currently in peak pricing hours (2-8 PM weekdays). Off-peak starts at 9 PM.';
  } else {
    tipIcon = 'üåô';
    tipText = 'Off-peak hours active! Good time to run dishwasher, laundry, or charge devices.';
  }

  document.getElementById('savingsTip').querySelector('.tip-icon').textContent = tipIcon;
  document.getElementById('tipText').textContent = tipText;

  // Build hourly table for today
  buildHourlyTable(data);

  // Build charts
  buildFiveMinChart(data);
  buildHourlyAvgChart(data, 1);
  document.getElementById('chartSubtitle').textContent = 'Last 24 hours';

  // Update time
  document.getElementById('timeUpdated').textContent = `Updated ${getTimeAgo(lastUpdateTime)}`;

  btn.classList.remove('loading');
  btn.disabled = false;
}

// Event listeners
document.getElementById('refreshBtn').addEventListener('click', updateDashboard);

// Table toggle
document.getElementById('tableToggle').addEventListener('click', function() {
  const table = document.getElementById('hourlyTable');
  const icon = this.querySelector('.toggle-icon');
  // Use inline maxHeight so tables collapse consistently across browsers
  const isOpen = table.style.maxHeight && table.style.maxHeight !== '0px';
  if (isOpen) {
    table.style.maxHeight = '0px';
    icon.classList.remove('open');
  } else {
    // set to scrollHeight to animate open
    table.style.maxHeight = table.scrollHeight + 'px';
    icon.classList.add('open');
  }
});

// Initial load and auto-update
document.addEventListener('DOMContentLoaded', () => {
  updateDashboard();
  setInterval(updateDashboard, 5 * 60 * 1000);
  setInterval(() => {
    if (lastUpdateTime) {
      document.getElementById('timeUpdated').textContent = `Updated ${getTimeAgo(lastUpdateTime)}`;
    }
  }, 10 * 1000);
});
</script>
</body>
</html>
