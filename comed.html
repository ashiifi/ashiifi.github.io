<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Comed Hourly Pricing Dashboard</title>
<!-- Google Fonts Roboto -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* Material Design inspired reset & fonts */
  body {
    font-family: 'Roboto', sans-serif;
    background: #fafafa;
    margin: 2rem;
    color: #202124;
    text-align: center;
  }

  h1 {
    font-weight: 700;
    font-size: 2.75rem;
    margin-bottom: 0.25rem;
    color: #1E88E5; /* Material Blue 600 */
  }

  #byline {
    font-style: italic;
    font-weight: 400;
    font-size: 1rem;
    color: #5f6368; /* Material grey */
    margin-bottom: 2rem;
  }
  #byline a {
    color: #1E88E5;
    text-decoration: none;
    transition: color 0.2s ease;
  }
  #byline a:hover {
    color: #1565C0; /* Blue 800 */
    text-decoration: underline;
  }

  #currentPrice {
    font-weight: 700;
    font-size: 4.5rem;
    margin-bottom: 0.3rem;
    font-variant-numeric: tabular-nums;
    letter-spacing: -0.03em;
  }

  #priceIndicator {
    font-weight: 500;
    font-size: 1.25rem;
    margin-bottom: 0.6rem;
    padding: 6px 12px;
    border-radius: 20px;
    display: inline-block;
    color: white;
    user-select: none;
  }

  #lastUpdated {
    font-size: 1.1rem;
    color: #5f6368;
    margin-bottom: 3rem;
  }

  /* Colors for price status */
  .cheap {
    background-color: #4caf50; /* Green 500 */
  }
  .normal {
    background-color: #ff9800; /* Orange 500 */
  }
  .expensive {
    background-color: #f44336; /* Red 500 */
  }

  .chart-title {
    font-weight: 600;
    font-size: 1.3rem;
    color: #202124;
    margin: 1rem 0 0.6rem 0;
    text-align: left;
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
    user-select: none;
  }

  .chart-container {
    max-width: 900px;
    margin: 0 auto 4rem;
  }

  canvas {
    background: #fff;
    border-radius: 16px;
    box-shadow:
      0 4px 10px rgb(0 0 0 / 0.1),
      0 1px 3px rgb(0 0 0 / 0.06);
  }
</style>
</head>
<body>
  <h1>Comed Hourly Pricing Dashboard</h1>
  <div id="byline">
    created by 
    <a href="https://www.linkedin.com/in/abubakrsharif/" target="_blank" rel="noopener noreferrer">Abubakr Sharif</a>
  </div>

  <div id="currentPrice" class="">Loading...</div>
  <div id="priceIndicator"></div>
  <div id="lastUpdated"></div>

  <div class="chart-container">
    <div class="chart-title">Recent 5-Minute Interval Prices (Past 5 Hours)</div>
    <canvas id="fiveMinChart"></canvas>
  </div>

  <div class="chart-container">
    <div class="chart-title">Hourly Average Price (Past 1 Day)</div>
    <canvas id="hourlyAvgChart"></canvas>
  </div>

<script>
const proxyUrl = 'https://corsproxy.io/?';
const feedUrl = 'https://hourlypricing.comed.com/api?type=5minutefeed&format=json';

let fiveMinChart, hourlyAvgChart;

function getColorForPrice(price) {
  if (price < 0.04) return '#4caf50';  // Green 500 for cheap
  if (price < 0.10) return '#ff9800';  // Orange 500 for normal
  return '#f44336';                    // Red 500 for expensive
}

function getPriceStatus(price) {
  if (price < 0.04) return {text: "Currently Cheap", className: "cheap"};
  if (price < 0.10) return {text: "Currently Normal", className: "normal"};
  return {text: "Currently Expensive", className: "expensive"};
}

function zpad(num) {
  return num.toString().padStart(2, '0');
}

async function fetchData() {
  const resp = await fetch(proxyUrl + encodeURIComponent(feedUrl));
  return await resp.json();
}

function buildFiveMinChart(data) {
  const now = Date.now();
  const cutoff = now - 5 * 60 * 60 * 1000;
  const recent = data.filter(d => +d.millisUTC >= cutoff);
  recent.sort((a, b) => +a.millisUTC - +b.millisUTC);

  const labels = recent.map((d) => {
    const dt = new Date(+d.millisUTC);
    return dt.getMinutes() % 15 === 0
      ? dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
      : '';
  });
  const values = recent.map(d => +d.price / 100);
  const pointColors = recent.map(d => getColorForPrice(+d.price / 100));

  if (fiveMinChart) fiveMinChart.destroy();

  const ctx = document.getElementById('fiveMinChart').getContext('2d');
  fiveMinChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: '5-Min Price ($/kWh)',
        data: values,
        borderColor: '#1E88E5',
        backgroundColor: 'rgba(30, 136, 229, 0.15)',
        fill: true,
        tension: 0.4,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: pointColors,
        pointBorderColor: '#fff',
        borderWidth: 3,
        cubicInterpolationMode: 'monotone',
      }]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          backgroundColor: '#1E88E5',
          titleColor: '#fff',
          bodyColor: '#fff',
          callbacks: {
            label: ctx => `$${ctx.parsed.y.toFixed(4)} / kWh`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#202124',
            maxRotation: 45,
            minRotation: 45,
            font: { weight: '600', size: 14 }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#202124',
            callback: val => `$${val.toFixed(3)}`,
            font: { weight: '600' }
          },
          grid: {
            color: 'rgba(30, 136, 229, 0.1)',
            borderDash: [5, 5]
          }
        }
      }
    }
  });
}

function buildHourlyAvgChart(data, days = 1) {
  const now = Date.now();
  const cutoff = now - days * 24 * 60 * 60 * 1000;
  const relevant = data.filter(d => +d.millisUTC >= cutoff);

  const hourly = {};
  relevant.forEach(entry => {
    const date = new Date(+entry.millisUTC);
    const key = `${date.getFullYear()}-${zpad(date.getMonth()+1)}-${zpad(date.getDate())}T${zpad(date.getHours())}`;
    if (!hourly[key]) hourly[key] = [];
    hourly[key].push(+entry.price);
  });

  const entries = Object.entries(hourly).sort((a,b) => new Date(a[0]) - new Date(b[0]));

  const labels = entries.map(e => {
    const [datePart, hourPart] = e[0].split('T');
    const [year, month, day] = datePart.split('-').map(Number);
    const hour = Number(hourPart);
    const dt = new Date(year, month - 1, day, hour);
    return dt.toLocaleString([], {month:'short', day:'numeric', hour:'numeric'} );
  });

  const avgPrices = entries.map(e => ((e[1].reduce((s,p)=>s+p,0) / e[1].length) / 100));
  const barColors = avgPrices.map(p => getColorForPrice(p));
  const values = avgPrices.map(p => +p.toFixed(4));

  if (hourlyAvgChart) hourlyAvgChart.destroy();

  const ctx = document.getElementById('hourlyAvgChart').getContext('2d');
  hourlyAvgChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Hourly Avg ($/kWh)',
        data: values,
        backgroundColor: barColors,
        borderRadius: 8,
        borderSkipped: false,
        maxBarThickness: 50
      }]
    },
    options: {
      responsive: true,
      interaction: { mode: 'nearest', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { 
          enabled: true,
          backgroundColor: '#1E88E5',
          titleColor: '#fff',
          bodyColor: '#fff',
          callbacks: {
            label: ctx => `$${ctx.parsed.y.toFixed(4)} / kWh`
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#202124',
            maxRotation: 45,
            minRotation: 45,
            font: { weight: '600', size: 14 }
          },
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          ticks: {
            color: '#202124',
            callback: val => `$${val.toFixed(3)}`,
            font: { weight: '600' }
          },
          grid: {
            color: 'rgba(30, 136, 229, 0.1)',
            borderDash: [5, 5]
          }
        }
      }
    }
  });
}

async function updateDashboard() {
  const data = await fetchData();

  const now = Date.now();
  const validEntries = data.filter(d => +d.millisUTC <= now);
  const latest = validEntries.reduce((prev, curr) => +curr.millisUTC > +prev.millisUTC ? curr : validEntries[0]);
  const priceDollars = (+latest.price / 100);
  const priceFixed = priceDollars.toFixed(4);

  const currentPriceEl = document.getElementById('currentPrice');
  currentPriceEl.textContent = `$${priceFixed} / kWh`;
  currentPriceEl.style.color = getColorForPrice(priceDollars);

  // Show price status indicator below current price
  const indicator = getPriceStatus(priceDollars);
  const priceIndicatorEl = document.getElementById('priceIndicator');
  priceIndicatorEl.textContent = indicator.text;
  priceIndicatorEl.className = indicator.className;

  const lastUpdatedEl = document.getElementById('lastUpdated');
  const timestamp = new Date(+latest.millisUTC);
  lastUpdatedEl.textContent = `Last updated: ${timestamp.toLocaleString('en-US', { timeZone: 'America/Chicago' })} CST`;

  buildFiveMinChart(data);
  buildHourlyAvgChart(data, 1);
}

document.addEventListener('DOMContentLoaded', () => {
  updateDashboard();
  setInterval(updateDashboard, 5 * 60 * 1000);
});
</script>
</body>
</html>
